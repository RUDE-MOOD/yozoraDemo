# ノスタージア WEB3Dのデモです

# TODO LIST
```bash
＝＝＝やり直し＝＝＝
1.ドーム形を立方体にする ✅️
2.レイヤーを積み上げること ✅️
3.ピンチイン・ピンチアウトの修正
4.プロンプトの精度上げ

＝＝＝BugFix＝＝＝
1.星を作成したら、最上階のレイヤーを超えて画面外に出てしまう✅️
2.カメラ移動時に、「ラグる」という感覚がする

＝＝＝advanced機能＝＝＝
1.星データの管理をclass化する


＝＝＝機能系＝＝＝
1.meshを作って一つの星を打ち上げる✅️
2.dreiライブラリのTextを作って星の情報を画面上に表示する✅️
3.UIを追加して、入力欄を追加✅️


4.ディレクトリ構造を整理する(apis,store,pages,router,utilsなど)
src/
├── apis/       # Supabase, Geminiとの通信ロジック
├── components/ # Effects, Experience, MyStars, UI などの部品
├── router/     # ルーター（画面遷移制御）
├── store/      # Zustand（星のデータやユーザー情報の管理）
├── pages/      # メイン画面以外のページ
├── utils/      # 感情スコア計算、request、日付フォーマットなどの関数
├── supabase/   # supabase関連（EdgeFunction、GEMINIへのプロンプトをここに書く）
└── App.js      # 全体の統合
5.生成された星をクリックして、詳細情報が表示できるように✅️
   - StarDetailModalコンポーネントを新規作成
   - 表示情報：生成時刻、座標(X/Y/Z)、大きさ、色(HEXコード)、日記テキスト
   - レスポンシブデザイン（モバイル・デスクトップ両対応）
   - グラスモーフィズム + グラデーション（紫→青）の宇宙テーマ
   - 各情報セクションに色分けされたアイコン（🕐📍📏🎨📝）
   - データフロー：UserStar → UserAddedStars → Experience → App → UI → StarDetailModal
6.星のデータをsupabaseに保存し、userStarsステートを更新する✅️
7.GEMINIのAPIを導入し、ユーザーが書いた日記の感情を分析できるように✅️
8.重み付けのアルゴリズムを作る
9.音声ガイド追加（画面を開く時とか、日記を書き終える時とか、音声ファイルを再生、ローカル保存）
10.日記を書き終えたら、画面が自動的に出来立ての星のポジションへ移動する✅️
11.azureVMでデプロイ✅️
＝＝＝ビジュアル系＝＝＝
1.shadertoyからStarNestを入れ直す（skybox交換）　https://www.shadertoy.com/view/XlfGRj
2.ディフォルトの色合い3パターン出す✅️
3.レイヤー3の遠い星を大きくする

```
## Development Tools
このプロジェクトは **Antigravity + Skills** AI を使用して開発されました。
- **Antigravity**: 高度なエージェントAIによるコーディング支援
- **Skills**: R3F (React Three Fiber) に特化した専門知識モジュール（Geometry, Postprocessing, Shadersなど）を活用し、ベストプラクティスに沿った実装を行っています。



# 環境初期化
1.git cloneまたはソースコードをダウンロードする<br>
2.フォルダーパスのターミナルを開いてyarnでライブラリを初期化（学校のネットワークでうまくできない場合はテザリングなど別のネット環境でリトライ）<br>
3.初期化ができ次第、yarn devで実行する<br>


<h2>レイヤー構造</h2>
<h4>プラネタリウム自体が７つのレイヤーでできている。</h4>
<ol>
  <li>背景（宇宙の色）<br>Three.jsのシェーダー。自由に変えられるようにするため画像を使用しない。</li>
  <li>流体層（天の川風）<br>GPUへの負荷の最小限に抑えるため、ノイズシェーダーを使用。UVマップをゆっくりずらすことで動いているように見せる。</li>
  <li>背景の遠い星 <br>ユーザーが操作しないのでノイズマップですませる。</li>
  <li>霧 <br>さらに立体感を出すためのレイヤー。3Dボリュームでやるとすごく重たくなるのでこれもノイズマップで実現する。深度に応じて透明度の変化もできる。</li>
  <li>星（ユーザーが操作できる）<br>3Dで描画する。InstancedMeshを使用し、独自のシェーダーで光り輝く星（光核＋十字フレア）を表現。個別に色やサイズが異なり、瞬いている。</li>
  <li>ビネット <br>Effectsコンポーネントで実現。</li>
  <li>UI描画 （ユーザーが操作できる）<br>TailwindCSSを用いたHTMLオーバーレイ。グラスモーフィズムデザインで、日記の投稿フォームなどを提供。</li>
</ol>
<p>こういう風にレイヤー毎に分けると、各要素を独立させレイヤー同士の直接依存が生じず拡張性を高めることができる。レイヤー毎の描画トグル・テーマの切り替え・低スペック端末向けのパフォーマンス描画モードも実装可能。</p>

# コンポーネント
## Experience
各コンポーネントを組み立てるためのメインコンテナ。
CameraControlsを使用し、ズームや移動の制限（最小・最大距離、パン範囲）を設定済み。
スマホなどのタッチ操作（ピンチズーム）にも対応。


## Effects
`@react-three/postprocessing`を使用した映像効果を担当。
- **Bloom**: 星の輝きを強調し、光暈（ハロー）を追加。
- **Noise**: フィルムライクな粒子感を加え、デジタル的な冷たさを軽減。
- **Vignette**: 画面四隅を減光させ、視線を中央へ誘導しつつ没入感を高める。
- **ToneMapping**: HDRレンダリングの色調を補正（ACESFilmic）し、白飛びを抑えつつコントラストを確保。

## SkyBox
以前のSkydome（半球体）から変更し、複数の平面レイヤーを重ねた構造（Cuboid的アプローチ）。
以下の4層で深みのある夜空を表現：
1. **Background**: 宇宙のベースカラー
2. **Fluid**: 天の川のような流体ノイズ
3. **Stars**: 瞬く遠景の星々
4. **Fog**: 奥行きを出すための霧
各レイヤーは専用のシェーダーで描画され、軽量かつ表現豊かに実装。

## SkyBoxの色合いはどうやって決めたの？
1. Layer1 Backgroundの宇宙背景の色を決める
   <br>255行　
   backgroundMaterial colorTop="#000000" colorBottom="#101035" 
   <br>
   colorTopは上部の色、colorBottomは下部の色<br>
2. Layer2 Fluidの動いている天の川の色を決める<br>
   269~270行 <colorA="#101035" colorB="#551a8b" /><br>
   colorAはメインな色、colorBは輝く部分の色<br>
3. Layer3 Starsの背景の遠い星の色を決める<br>
   289行 <color="#ffffff" /><br>
4. Layer4 Fogの薄い霧の色を決める<br>
   308行 <color="#aaaaff" /><br>

## MyStars
レイヤー5に相当する、ユーザー自身の星を描画するコンポーネント。
- **InstancedMesh**: 1000個以上の星を軽量に描画するためにインスタンシング技術を使用。
- **Custom Shader**: 円形の光核と十字のレンズフレア（光条）を持つ独自のシェーダーで描画。
- **Attributes**: 星ごとに個別の位置、色（青、シアン、ゴールド、ピンク）、サイズ、瞬きのタイミング（位相）を持つ。
- **Billboarding**: シェーダー内で頂点計算を行い、常にカメラの方を向くように制御。

## UI
HTMLオーバーレイとして実装されたユーザーインターフェース。
- **TailwindCSS**: グラスモーフィズム（すりガラス）デザインを採用し、夜空の雰囲気にマッチさせた。
- **Components**:
    - **Menu Button**: 画面右上に配置された3点リーダーボタン。
    - **Diary Modal**: 「日記を書く」を選択すると出現する入力フォーム。テキスト入力時に文字がふわっと現れるアニメーション演出付き。
    - **Star Detail Modal**: 星をクリックすると表示される詳細情報モーダル。
        - **表示情報**: 生成時刻、3D座標(X/Y/Z)、大きさ、色(HEXコード + カラープレビュー)、日記テキスト
        - **デザイン**: グラスモーフィズム + グラデーション背景（紫→青）、各セクションに色分けされたアイコン
        - **レスポンシブ**: モバイル・デスクトップ両対応、タッチターゲット最適化
        - **アニメーション**: ホバーエフェクト、スムーズな開閉トランジション(300ms)
- **App Integration**: `<Canvas>`の外側に配置され、3Dシーンの上に重なって表示される。

## UserAddedStars
ユーザーが日記を書くことで追加される星のレイヤー。
- **User Interaction**: UIの日記フォームから送信されたデータに基づき、リアルタイムに生成される。
- **Properties**: 
    - **Randomness**: 位置、色、サイズ、瞬きのパターンがランダムに割り当てられる。
    - **Date Label**: `@react-three/drei`の`Text`コンポーネントを使用し、星の下に生成日時（例: "26/1/26 16:25"）を表示。
- **Camera Integration**: 生成エリアはカメラの移動制限範囲内に収まるように計算されており、確実に近づいて鑑賞できる。

# 日記から星へ
「日記を書く」ことは、ただ記録を残すだけでなく、夜空に新しい星を打ち上げる行為としてデザインされています。

1. **Input**: ユーザーがUIの日記モードでテキストを入力し、「送信」を押す。
2. **State Update**: `App.jsx`で管理されている`userStars`ステートに、新しい星のデータ（日時、ランダムな座標・色・サイズ）が追加される。
3. **Render**: 
   - `Experience`コンポーネント内の`UserAddedStars`が更新を検知。
   - 新しい`UserStar`コンポーネントが3D空間上の指定座標に出現。
   - 独自のシェーダーマテリアルで輝き始め、ビルボード化されたテキストで日付が表示される。
4. **Interaction**: 
   - ユーザーが星をクリックすると、`UserStar`の`handleClick`が発火。
   - データフロー: `UserStar` → `UserAddedStars` → `Experience` → `App` → `UI` → `StarDetailModal`
   - `StarDetailModal`が開き、星の詳細情報（生成時刻、座標、大きさ、色、日記テキスト）を表示。
5. **Result**: ユーザーの想い（日記）が、可視化された「星」となってプラネタリウムの一部になり、いつでもクリックして振り返ることができる。



# データベース接続
.env exampleに参照

# データベース構造
## 星データテーブル (t_stars)
| コラム | データ型(supabaseの選択肢で設置する) | ディフォルト値|説明 |
|--------|----------|------|------|
| id🔑 | uuid | NULL | UUIDで生成されたユニークなID |
| position | jsonb | NULL | 位置 |
| color | jsonb | NULL | 色 |
| scale | Float4 | NULL | 大きさ |
| random | Float4 | NULL | 星の瞬きアニメーションの位相をずらすための値（各星が異なるタイミングで瞬くようにするため） |
| created_at | timestamptz | NULL | ISOフォーマットの生成日時（データベース保存用） |
| display_date | text | NULL | YY/MM/DD HH:mmフォーマットの生成日時（画面表示用） |
| text | text | NULL | 日記テキスト |
| analysis_data | jsonb | NULL | Gemini APIからの分析結果（感情、褒め言葉など） |


# Gemini APIの使用 (テスト用のTEST-APIを実行する時に、学校のネットワークから弾かれる可能性もある、テザリングを使うのは推薦)
## 概要
APIキーを安全に扱うため、クライアントサイドではなく **Supabase Edge Functions** 経由で Gemini API を呼び出します。

## Edge Function の構成 (`supabase/functions/analyze-diary/`)
- **API**: Google Gemini 2.5 Flash
- **機能**: ユーザーの日記テキストを受け取り、`emotion`（7つの感情）と `feedback`（励ましのメッセージ）を返します。
- **認証**: Supabase の Anon Key で保護されています。

## セットアップ手順
1. **Gemini API キーの取得**: [Google AI Studio](https://aistudio.google.com/apikey) で取得
2. **Secret の設定**: Supabase Dashboard > Edge Functions > Secrets に `GEMINI_API_KEY` を設定
3. **デプロイ（注意⚠️プロンプトが記載したindex.tsを編集するたびに再デプロイが必要）**: 以下のコマンドでクラウドに反映
   ```bash
   npx supabase functions deploy analyze-diary
   ```

## 動作確認
PowerShell での文字化けを防ぐため、専用の Node.js スクリプトを使用します。

```bash
# テスト実行
node test-api.js
```

## GEMINIプロンプト更新時のフロー
1. `index.ts` を修正
2. `npx supabase functions deploy analyze-diary` でデプロイ
3. `node test-api.js` で動作確認


# プロンプト
```
あなたは優しく共感的なカウンセラーです。以下の日記を読んで、感情を正確に分析し、ユーザーを励ましてください。

日記テキスト: "${diaryText}"

【感情の定義】
- 喜び：楽しい、嬉しい、幸せ、満足などのポジティブな感情
- 悲しみ：悲しい、寂しい、落ち込んでいる、失望などのネガティブな感情
- 怒り：腹が立つ、イライラする、不満などの怒りの感情
- 不安：心配、恐れ、緊張、不安などの感情
- 愛：愛情、感謝、温かさ、親しみなどの感情
- 興奮：ワクワク、ドキドキ、高揚感などの感情
- 平穏：穏やか、リラックス、落ち着いているなどの感情

以下のJSON形式で回答してください（他の説明は一切不要です）：
{
  "emotion": "喜び" または "悲しみ" または "怒り" または "不安" または "愛" または "興奮" または "平穏",
  "feedback": "ユーザーへの温かく励ましのメッセージ（1-2文で簡潔に）"
}

重要：
- 日記の内容を注意深く読み、本当に表現されている感情を選んでください
- 「楽しい」「嬉しい」などの言葉があれば「喜び」を選んでください
- feedbackは必ず肯定的で、ユーザーの気持ちに寄り添い、前向きな言葉をかけてください
```
